name: Process Club Data

permissions:
  contents: write

on:
  push:
    branches:
      - master
      - ci-pipeline-scaffold
    paths:
      - 'data/competitors_*.csv'
      - 'data/ClubEvents_*.xlsx'
  workflow_dispatch:
   inputs:
     mode:
       description: 'Run mode: competitors or events'
       required: false
       default: ''
     year:
       description: 'Year to process (e.g. 2025)'
       required: false
       default: ''
     verbosity:
       description: 'Verbosity level for dotnet test (minimal, normal, detailed)'
       required: false
       default: 'minimal'
      
jobs:
  build-test-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install pandas openpyxl

      - name: Restore dependencies
        run: dotnet restore processor/ClubProcessor.sln

      - name: Build solution
        run: dotnet build processor/ClubProcessor.sln --configuration Release

      - name: List tests
        run: dotnet test processor/ClubProcessor.sln --list-tests

      - name: Run tests
        run: dotnet test processor/ClubProcessor.sln --verbosity ${{ github.event.inputs.verbosity != '' && github.event.inputs.verbosity || 'minimal' }}
 
      - name: Detect changed files and extract/process
        run: |
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          if ! echo "$CHANGED" | grep -qE 'data/competitors_.*\.csv|data/ClubEvents_.*\.xlsx'; then
            echo "[WARN] No matching files detected — falling back to latest matching files"
            CHANGED=$(ls -t data/competitors_*.csv data/ClubEvents_*.xlsx 2>/dev/null | head -n2 || true)
          fi
          echo "[INFO] Files to process:"
          echo "$CHANGED"
          YEAR="${{ github.event.inputs.year }}"
          if [ -z "$YEAR" ]; then
            YEAR=$(date +'%Y')
            echo "[INFO] No year input provided — defaulting to current year: $YEAR"
          fi
          
          MODE=$(echo "${{ github.event.inputs.mode }}" | tr '[:upper:]' '[:lower:]')
          
          if [ "${{ github.event.inputs.mode }}" = "competitors" ]; then
            echo "[INFO] Manual trigger: competitors mode"
            FILE="data/competitors_${YEAR}.csv"
            if [ -f "$FILE" ]; then
              echo "[INFO] Found file: $FILE"
              echo "$FILE" > .competitor_csv_path
              dotnet run --project processor/ClubProcessor/ClubProcessor.csproj -- --mode competitors --file "$FILE"
            else
              echo "[ERROR] File not found: $FILE"
              exit 1
            fi
          
          elif [ "${{ github.event.inputs.mode }}" = "events" ]; then
            echo "[INFO] Manual trigger: events mode"
            FILE="data/ClubEvents_${YEAR}.xlsx"
            if [ -f "$FILE" ]; then
              echo "[INFO] Found file: $FILE"
              echo "$FILE" > .club_events_xlsx_path
              sha256sum "$FILE" || true
              python3 scripts/extract_club_events.py "$FILE" data/extracted/
            else
              echo "[ERROR] File not found: $FILE"
              exit 1
            fi
          
          else
            echo "[INFO] No manual mode specified — checking changed files"
            IFS=$'\n'
            for FILE in $CHANGED; do
              if [[ "$FILE" == data/ClubEvents_*.xlsx ]]; then
                echo "[INFO] Detected ClubEvents XLSX: $FILE"
                echo "$FILE" > .club_events_xlsx_path
                sha256sum "$FILE" || true
                python3 scripts/extract_club_events.py "$FILE" data/extracted/
              elif [[ "$FILE" == data/competitors_*.csv ]]; then
                echo "[INFO] Detected competitors CSV: $FILE"
                echo "$FILE" > .competitor_csv_path
                dotnet run --project processor/ClubProcessor/ClubProcessor.csproj -- --mode competitors --file "$FILE"
              fi
            done
            
            if [ -z "$CHANGED" ]; then
              echo "[WARN] No matching files found to process"
            fi
          fi

      - name: Run processor if extracted event CSVs exist
        run: |
          for year_dir in data/extracted/*; do
            if compgen -G "$year_dir/Calendar_*.csv" > /dev/null && \
               [[ -d "$year_dir/events" ]] && \
               compgen -G "$year_dir/events/Event_*.csv" > /dev/null; then
          
              echo "[INFO] Detected full extracted dataset in: $year_dir"
              dotnet run --project processor/ClubProcessor/ClubProcessor.csproj -- --mode events --file "$year_dir"
            else
              echo "[INFO] Skipping $year_dir — required files not found"
            fi
          done
          
      - name: Upload extracted CSV artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extracted-csvs
          path: artifacts/extracted/
          
      - name: Summarise competitor metrics
        run: |
          if [ -f ".competitor_csv_path" ]; then
            file=$(cat .competitor_csv_path)
            year=$(basename "$file" | grep -oP '\d{4}')
            dbPath="data/club_competitors_${year}.db"
      
            if [ -f "$dbPath" ]; then
              echo "[INFO] Summarising metrics for $dbPath"
              python3 scripts/summarise_competitor_metrics.py --db "$dbPath"
            else
              echo "[WARN] DB not found: $dbPath — skipping metrics summary"
            fi
          else
            echo "[INFO] No competitor CSV processed — skipping metrics summary"
          fi

      - name: Prepare commit inputs for Competitor SQLite DB
        run: |
          if [ -f ".competitor_csv_path" ]; then
            file=$(cat .competitor_csv_path)
            year=$(basename "$file" | grep -oP '\d{4}')
            dbPath="data/club_competitors_${year}.db"
      
            if [ -f "$dbPath" ]; then
              echo "[INFO] Found DB: $dbPath"
              echo "dbPath=$dbPath" >> $GITHUB_ENV
              echo "commitMessage=Persisted competitor DB for ${year} import [ci skip]" >> $GITHUB_ENV
              echo "skipCommit=false" >> $GITHUB_ENV
            else
              echo "[INFO] DB not found: $dbPath — skipping commit"
              echo "skipCommit=true" >> $GITHUB_ENV
            fi
          else
            echo "[INFO] No competitor CSV marker file — skipping commit"
            echo "skipCommit=true" >> $GITHUB_ENV
          fi
        shell: bash
      
      - name: Commit Competitor DB if needed
        if: ${{ env.skipCommit != 'true' }}
        uses: ./.github/actions/commit-db
        with:
          db-path: ${{ env.dbPath }}
          commit-message: ${{ env.commitMessage }}
      
      - name: Prepare commit inputs for ClubEvents SQLite DB
        run: |
          if [ -f ".club_events_xlsx_path" ]; then
            file=$(cat .club_events_xlsx_path)
            year=$(basename "$file" | grep -oP '\d{4}')
            dbPath="data/club_events_${year}.db"
          
            if [ -f "$dbPath" ]; then
              echo "[INFO] Found DB: $dbPath"
              echo "dbPath=$dbPath" >> $GITHUB_ENV
              echo "commitMessage=Persisted ClubEvents DB for ${year} import [ci skip]" >> $GITHUB_ENV
              echo "skipCommit=false" >> $GITHUB_ENV
            else
              echo "[INFO] DB not found: $dbPath — skipping commit"
              echo "skipCommit=true" >> $GITHUB_ENV
            fi
          else
            echo "[INFO] No ClubEvents XLSX marker file — skipping commit"
            echo "skipCommit=true" >> $GITHUB_ENV
          fi
        shell: bash
      
      - name: Commit ClubEvents DB if needed
        if: ${{ env.skipCommit != 'true' }}
        uses: ./.github/actions/commit-db
        with:
          db-path: ${{ env.dbPath }}
          commit-message: ${{ env.commitMessage }}


     
      